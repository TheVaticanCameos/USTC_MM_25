# 作业4：微分方程模型（WIP）

> 作业 ddl：2025年5月3日（周六）23:59
> 提交内容：源代码 + 实验报告（pdf文件） + 其他补充说明文件（可选）

在复杂多变的现实世界中，许多自然现象和社会问题都蕴含着动态变化的规律，而这些规律往往可以通过微分方程（Differential Equations）来刻画。在本次实验中，我们将从如下三个选项中任选其一来练习使用微分方程来对实际问题进行建模。

> 注：为了避免无效内卷，**做多个任务的同学只按照实验报告中的第一个任务呈现分数**，**且最终以完成度为评判标准，与任务的本质难度无关，做较难作业的同学不一定得到更高的分数**

## 选项1：人口模型

根据最新的第七次全国人口普查数据，2020年中国人口达到14.1亿；2021年，中国人口自1949年以来首次出现下降，低于14亿；国家开放三胎政策，但大城市家庭的小孩数平均数低于2个。本实验旨在通过微分方程模型分析中国人口的变化趋势，并预测未来十年的人口变化。

为了便于大家的实现，下面我们先来介绍几种经典的人口模型。

### 马尔萨斯模型和自限模型

#### 基本原理

英国经济学家托马斯·罗伯特·马尔萨斯在其于1798年发表的《人口原理》中提出了第一个人口模型—— **指数增长模型** （也称 **马尔萨斯模型** ）。简而言之，马尔萨斯认为人类的相对出生率（指单位时间内平均每一人新生的婴儿数） $b$ 和相对死亡率 $d$ 均为常数，因此人口的自然增长率 $r$ 也为常数。

设时刻 $t$ 的人口数为 $N(t)$ ，初始时刻 $t_0$ 的人口数为 $N_0$ ，马尔萨斯认为 $N(t)$ 满足方程

$$
\begin{aligned}
\frac{dN}{dt}&=rN \\
N(t_0)&=N_0 \\
\end{aligned}    
$$

容易解出 

$$ 
N(t)=N_0 e^{r\left(t-t_0\right)}
$$

观察上述模型，不难发现：根据马尔萨斯的预测，人口竟然是呈指数级增长的！这显然不符合常识：人口不可能无限制地增长。因此需要在马尔萨斯模型中考虑人口增长的限制，这就得到了如下的 **自限模型** （也称 **Logistic 阻滞增长模型** ） 。

假设一定的环境下资源所能供养的最多人数为 $K$ （称为极限人口或环境容纳量）。设人口较少时其自然增长率为 $r$ ，则当前人口数为 $N$ 时，将人口增长率取为 $r\left(1-\frac{N}{K}\right)$ 是一个相对合理的选择。在此假设下，人口总数满足

$$
\begin{aligned}
\frac{dN}{dt}&=r\left(1-\frac{N}{K}\right)N \\
N(t_0)&=N_0 \\
\end{aligned}
$$

解得

$$
N(t)=\frac{K}{1+\left(\frac{K}{N_0}-1\right)e^{-r\left(t-t_0\right)}}
$$

不难发现，根据自限模型，随着时间的增加，人口总数趋于极限人口 $K$ ；当人口数达到 $K/2$ 时，人口增速最快；根据此模型预测出的人口随时间的变化为一条 S 形曲线。

> 题外话：在马尔萨斯的著作《人口原理》中，作者认为“人口按几何级数增长，而生活资源只按照算术级数增长，二者之间的矛盾导致饥荒、战争和疾病的周期性爆发”。虽然马尔萨斯人口论的提出具有其历史背景和局限性，但其作为第一个人口模型，为人口理论创造了积极意义。

#### 如何求解？

我们已经根据马尔萨斯模型以及自限模型得到了人口变化的表达式了， nice~ 

但是，这就结束了吗？

NO！

这其中含有的参数 $r, K$ 等都是未知的。但是没关系，我们可以从历史观测数据中拟合出这些参数。一种常用的方法是 [最小二乘拟合](https://zh.wikipedia.org/zh-hans/%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E6%B3%95)。

从数据中得到这些未知参数后，便可将模型用于预测未来的人口变化。

#### What's beyond？

马尔萨斯模型以及其衍生的自限模型的基本方程都是人口总数 $N(t)$ 关于时间 $t$ 的常微分方程

$$
\begin{aligned}
\frac{dN(t)}{dt}&=rN \\
N(t_0)&=N_0 \\
\end{aligned}
$$

这里对人口自然增长率 $r$ 的不同理解对应着不同的人口模型：认为 $r$ 是常数，即得到马尔萨斯模型；认为 $r=N\left(1-\frac{K}{N}\right)$ 即得到自限模型。事实上，通过对人口增长的不同建模，从而得到不同的 $r$ 的表现形式，都可以得到相应的人口模型。

> 思考：你还能提出哪些建模假设？分别导出的 $r$ 的表现形式如何？

### 随机模型

马尔萨斯模型和自限模型将人口数随时间的变化视为一个准确的函数，然而在现实情况下，人口数受诸多随机因素的影响，应当用随机变量来建模。下面我们来介绍基于随机变量的人口模型——随机模型。

我们用离散型随机变量 $X(t)$ 来表示 $t$ 时刻的人口数，即 $X(t)$ 只取自然数。我们记 $p_n(t)$ 为 $t$ 时刻人口数为非负整数 $n$ 的概率，即

$$
p_n(t)=P(X(t)=n),\quad n=0, 1, 2, \dots
$$

求解出 $p_n$ 后，即可使用 $X(t)$ 的统计信息（如均值、方差、高阶矩 etc）来刻画人口的变化。

下面我们来逐步分析 $p_n(t)$ 的影响因素。

#### 纯生模型

取一个很小的时间间隔 $\Delta t$ ，我们认为在时间区间 $(t, t+\Delta t)$ 之中，人口的变化仅与时刻 $t$ 的人口数有关，而与时间区间 $(0, t)$ 中的人口状态无关；并且我们假设人口的出生率 $b_n$ 以及死亡率 $d_n$ 仅与当前人口数 $n$ 有关，而与时间 $t$ 无关。

为了简化模型，下面我们先考虑仅有出生的情形。由于随机事件 { $X(t+\Delta t)=n$ } 可以拆分成两个不相容的随机事件之和，即{ $\Delta t$ 时间内出生 1 人 | $X(t)=n-1$ } 和 { $\Delta t$ 时间内无人出生 | $X(t)=n$ }。从而

$$
\begin{aligned}
p_n(t+\Delta t)&=P(X(t+\Delta t)=n) \\
&=b_{n-1}\Delta \cdot p_{n-1}(t)+(1-b_n\Delta t)p_n(t)+o(\Delta t) \\
\end{aligned}
$$

从而得到微分方程 

$$
\frac{dp_n(t)}{dt}+b_np_n(t)=b_{n-1}p_{n-1}(t)
$$

结合边界条件 $p_{N_0}\left(0\right)=1,\quad p_i(0)=0\ (i\ne N_0)$ 即可得到 $p_n(t)$ 的表达式，其中 $N_0$ 为初始时刻的人口数。

#### 纯死模型

和纯生模型类似，我们考虑只有死亡没有出生的情形。可以类似地得到方程

$$
\begin{aligned}
&\frac{dp_n(t)}{dt}+d_np_n(t)=d_{n+1}p_{n+1}(t) \\
&p_{N_0}(0)=1,\quad p_i(0)=0\ (i\ne N_0) \\
\end{aligned}
$$

#### 生灭过程模型

下面我们同时考虑出生与死亡。将随机事件 { $X(t+\Delta t)=n$ } 分解为三个不相容的随机事件之和：{ $\Delta t$ 出生 1 人 | $X(t)=n-1$ }, { $\Delta t$ 中无出生死亡 | $X(t)=n$ }, { $\Delta t$ 中死亡 1 人 | $X(t)=n+1$ }。

> 这里其实假设了 $\Delta t$ 时间内的死亡人数和出生人数都大于 0 的概率很小，可以忽略不计。

从而 

$$
p_n(t+\Delta t)=b_{n-1}\Delta t p_{n-1}(t)+(1-b_n\Delta t-d_n \Delta t)p_n(t)+d_{n+1}\Delta t p_{n+1}(t)+o(\Delta t)
$$

以及初始条件 $p_{N_0}(0)=1,\quad p_i(0)=0\quad (i\ne N_0)$。

#### 如何求解？

在上面的讨论中，我们已经得到了对人口变化的生灭过程建模。然而，方程中含有的 $p_n, b_n, d_n$ 都是未知的，如何求解这一系统呢？

事实上，和马尔萨斯模型类似，我们仍然需要对系统中的一些未知参数引入先验。一种常用的做法是设 $b_n=bn, d_n=dn$ ，此时生灭过程模型为

$$
\begin{aligned}
&\frac{dp_n}{dt}(t)=b(n-1)p_{n-1}(t)+d(n+1)p_{n+1}-(b+d)np_n(t) \\
&p_{N_0}(0)=1,\quad p_i(0)=0\quad (i\ne N_0) \\
\end{aligned}
$$

虽然此方程难以求解，但我们可以跳过 $p_n$ 的求解，而是直接求解 $X(t)$ 的数学期望和方差。

$$
E(t):=E(X(t))=\sum_{n=1}^\infty np_n(t)    
$$

对时间求导并代入上述方程可得

$$
\frac{dE}{dt}=b\sum_{n=1}^\infty n(n-1)p_{n-1}(t)+d\sum_{n=1}^\infty n(n+1)p_{n+1}(t)-(b+d)\sum_{n=1}^\infty n^2 p_n(t)
$$

化简得

$$
\frac{dE}{dt}=(b-d)\sum_{n=1}^\infty np_n(t)=(b-d)E(t)
$$

结合 $E(0)=N_0$ ，可解得 $E(t)=N_0e^{\left(b-d\right)t}=N_0 e^{rt}$。

啊哈！这一结果竟和马尔萨斯模型的结果一致！缘分，妙不可言~

与期望的计算方式类似，我们可以得到方差

$$
\sigma^2=\sum_{n=1}^\infty n^2 p_n(t)-E^2(t)=N_0\frac{b+d}{b-d}e^{\left(b-d\right)t}\cdot\left(e^{\left(b-d\right)t}-1\right)
$$

> 和马尔萨斯模型类似，这里也需要使用历史数据来拟合出模型中的未知参数 $b, d$ 。
> 此外，可以想象， $b_n, d_n$ 的选取方式并不只有这一种。我们欢迎大家在实验中提出自己的假设，并导出其对应的 $b_n, d_n$ 表达式进行建模。

### 实验要求

选项 1 的基本要求如下：
- 使用包含但不限于上述两种人口建模方式中的一种进行建模；
- 将数据集划分成两部分，使用其中前一部分来拟合出模型中的未知参数，使用后一部分来测试模型的预测准确度；
- 请使用合适的评价标准来衡量模型的性能。

注：
- 不选项不限制编程语言
- 不对交互界面做要求
- 人口统计数据可参考 [population.xlsx](./data/population.xlsx)

可能的加分项：如何清晰、准确地展现你的实验结果？你在模型中针对哪些因素，做出了哪些假设，导出了哪些创新性的设计？etc

参考文献：[谭永基《数学模型》](https://rec.ustc.edu.cn/share/efd879b0-2246-11f0-8dc5-3f1fe9a17364)

## 选项2：传染病模型

传染病模型用于研究疾病在人群中传播的动态变化规律。通过建立数学模型，可以预测疫情的发展趋势，评估防控措施的效果，并为公共卫生决策提供科学依据。常见的传染病模型包括SIR、SEIR和SIS模型，它们根据疾病的不同传播特点进行建模，能够有效刻画疾病在人群中的传播过程。

### SIR模型

#### 基本原理

SIR模型将总人口分为三个状态：
- **S (Susceptible)**：易感者，尚未感染但有可能感染疾病的人群；
- **I (Infectious)**：感染者，已经感染且具有传染性的人群；
- **R (Recovered)**：移除者，已经康复或死亡的人群，不再具有传染性。

模型假设总人口数固定（无出生、死亡或迁移），传播过程由以下微分方程描述：

$$
\frac{dS}{dt} = -\beta SI, \quad \frac{dI}{dt} = \beta SI - \gamma I, \quad \frac{dR}{dt} = \gamma I
$$

其中， $\beta$ 是传染率， $\gamma$ 是恢复率。

#### 如何求解

使用数值方法（如Euler法、RK4龙格-库塔法）对微分方程组进行求解。常见流程为：
1. 给定初始条件 $S(0), I(0), R(0)$ 。
2. 选择步长 $dt$，迭代计算 $S(t), I(t), R(t)$ 。
3. 根据数值解绘制感染人数随时间变化的曲线。

### SEIR模型

#### 基本原理

SEIR模型在SIR基础上增加了一个潜伏期阶段E（Exposed）：
- **E (Exposed)**：已感染但尚未具有传染性的人群。

微分方程组为：

$$
\frac{dS}{dt} = -\beta SI, \quad \frac{dE}{dt} = \beta SI - \sigma E, \quad \frac{dI}{dt} = \sigma E - \gamma I, \quad \frac{dR}{dt} = \gamma I
$$

其中， $\sigma$ 是潜伏期转为感染期的速率。

#### 如何求解

同样采用数值方法求解。步骤类似于SIR模型，但需同时跟踪E的变化。一般使用Python、Matlab等编程语言，通过SciPy库中的ODE求解器实现更高精度的模拟。

### SIS模型

#### 基本原理

SIS模型假设感染者康复后不会获得免疫，而是重新回到易感状态，常用于描述某些细菌感染或流行性感冒类疾病。模型包含两个状态：
- **S (Susceptible)**：易感者；
- **I (Infectious)**：感染者。

微分方程组为：

$$
\frac{dS}{dt} = -\beta SI + \gamma I, \quad \frac{dI}{dt} = \beta SI - \gamma I
$$

其中， $\gamma$ 仍表示恢复率。

#### 如何求解

与SIR模型类似，可采用Euler或高阶Runge-Kutta方法进行数值模拟。特别注意感染后个体回到易感状态，因此仿真过程中需正确处理S与I之间的动态转化。

### 实验要求

选项2的基本要求如下：
- 建立至少两种传染病模型（如SIR和SEIR），描述并推导其数学形式；
- 设计合理的参数并进行数值实验，绘制疫情传播随时间变化的曲线；
- 对比不同参数设置（如传染率、恢复率变化）对疾病传播趋势的影响，并进行合理分析。

注：
- 实验过程中需记录并展示参数设置与初值选择；
- 所有推导过程需完整展示，数值求解需给出核心代码或算法流程。

可能的加分项：
- 结合实际疫情数据进行模型拟合；
- 设计控制策略（如增加隔离、疫苗接种），并用模型验证其效果。


## 选项3：Poisson 图像融合

实际上，这是计算机图形学课程的第三个作业，相关的算法原理可以参考文档：[计算机图形学课程文档](https://github.com/USTC-CG/USTC_CG_25/tree/main/Homeworks/3_poisson_image_editing)，本课程为该算法提供了一个Matlab框架，可参考[Matlab框架](./poissonediting)

### 实验要求

选项 3 的基本要求如下：
- 完成文中的 Seamless cloning 的 Importing gradients 部分，务必写清楚该算法的原理，首先需要从偏微分方程开始分析，再到稀疏矩阵方程的构造；
- 实时拖动区域显示结果，需要录制视频；
- 请采用多个测试样例（大于等于4个）来直观说明算法的合理性。

注：
- 不选项不限制编程语言，可以利用框架[Matlab框架](./poissonediting)，也可以利用IMGUI等工具搭建C++框架，但是务必录制实时融合的视频；
- 由于Matlab框架可以实现不规则区域的融合，因此如果使用C++框架但没有实现该结果，会扣除很多分数。

可能的加分项：对梯度进行一些修正，比如使用Mixing gradients方法，并与现在的结果进行比较。
